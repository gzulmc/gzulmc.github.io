
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Spring security微服务实现 - gzulmc's 随笔记录</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spring-security" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="gzulmc&#39;s 随笔记录" class="md-header__button md-logo" aria-label="gzulmc's 随笔记录" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            gzulmc's 随笔记录
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Spring security微服务实现
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Python/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%9F%BA%E7%A1%80/" class="md-tabs__link">
          
  
  
    
  
  Python

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Django/Django%E5%9F%BA%E7%A1%80/" class="md-tabs__link">
          
  
  
    
  
  Django

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Docker/Docker%E8%AF%A6%E8%A7%A3/" class="md-tabs__link">
          
  
  
    
  
  Docker

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
    
  
  Java

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="gzulmc&#39;s 随笔记录" class="md-nav__button md-logo" aria-label="gzulmc's 随笔记录" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    gzulmc's 随笔记录
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Python/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    面向对象基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Python/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BF%9B%E9%98%B6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    面向对象进阶
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Python/%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    进程和线程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Python/%E5%9B%BE%E5%83%8F%E5%92%8C%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    图像和文档处理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Python/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%BA%94%E7%94%A8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    网络编程应用
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Python/%E6%96%87%E4%BB%B6%E5%92%8C%E5%BC%82%E5%B8%B8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    文件和异常
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Django
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Django
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Django/Django%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Django基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Django/%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    数据模型
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Docker
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Docker
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Docker/Docker%E8%AF%A6%E8%A7%A3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docker详解
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Java
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Java
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#spring-security" class="md-nav__link">
    <span class="md-ellipsis">
      第一部分：Spring Security 学习路径与企业应用重点
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第一部分：Spring Security 学习路径与企业应用重点">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      学习路径（由浅入深）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      企业开发中的侧重点
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    <span class="md-ellipsis">
      第二部分：理论讲解 - 微服务中的角色关系
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第二部分：理论讲解 - 微服务中的角色关系">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      角色分工
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sso-oauth2" class="md-nav__link">
    <span class="md-ellipsis">
      单点登录 (SSO) 与 OAuth2 的关系
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-_1" class="md-nav__link">
    <span class="md-ellipsis">
      第三部分：代码实战 - 构建微服务安全系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第三部分：代码实战 - 构建微服务安全系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      项目结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-parent-pom-sso-security-demopomxml" class="md-nav__link">
    <span class="md-ellipsis">
      1. Parent POM (sso-security-demo/pom.xml)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-auth-server" class="md-nav__link">
    <span class="md-ellipsis">
      2. auth-server 模块
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-gateway-service" class="md-nav__link">
    <span class="md-ellipsis">
      3. gateway-service 模块
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-order-service" class="md-nav__link">
    <span class="md-ellipsis">
      4. order-service 模块 (资源服务器)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-product-service" class="md-nav__link">
    <span class="md-ellipsis">
      5. product-service 模块 (资源服务器)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      第四部分：运行与测试
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第四部分：运行与测试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      使用本地直接运行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-curl" class="md-nav__link">
    <span class="md-ellipsis">
      API 调用测试 (使用 curl)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-_2" class="md-nav__link">
    <span class="md-ellipsis">
      第五部分：最终产出 - 项目代码与解释文档
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第五部分：最终产出 - 项目代码与解释文档">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#readmemd" class="md-nav__link">
    <span class="md-ellipsis">
      README.md (解释文档)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-api" class="md-nav__link">
    <span class="md-ellipsis">
      2. 访问受保护的API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 访问受保护的API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a" class="md-nav__link">
    <span class="md-ellipsis">
      a. 访问订单服务
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-token" class="md-nav__link">
    <span class="md-ellipsis">
      b. 访问商品服务 (使用同一个Token)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 测试权限控制
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#oauth2" class="md-nav__link">
    <span class="md-ellipsis">
      用通俗易懂的例子来说明OAuth2的四个角色是理解其工作原理的最佳方式。
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      一、核心问题
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      二、通俗易懂的酒店例子
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#oauth2_1" class="md-nav__link">
    <span class="md-ellipsis">
      三、OAuth2的四个角色
    </span>
  </a>
  
    <nav class="md-nav" aria-label="三、OAuth2的四个角色">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-resource-owner" class="md-nav__link">
    <span class="md-ellipsis">
      1. 资源所有者 (Resource Owner)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-client" class="md-nav__link">
    <span class="md-ellipsis">
      2. 客户端 (Client)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-authorization-server" class="md-nav__link">
    <span class="md-ellipsis">
      3. 授权服务器 (Authorization Server)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-resource-server" class="md-nav__link">
    <span class="md-ellipsis">
      4. 资源服务器 (Resource Server)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      四、流程串讲
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      总结表格
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Spring security微服务实现</h1>

<p>好的，这是一个非常好的问题，它触及了现代Java后端开发，特别是微服务架构安全的核心。我会按照你的要求，从学习路径、企业应用重点，到微服务中的角色关系，再到OAuth2与SSO的配合，最后提供一个完整的、可运行的后端代码示例和详细的讲解文档。</p>
<p>我们将分步进行：</p>
<ol>
<li><strong>Spring Security 学习路径与企业应用重点</strong></li>
<li><strong>理论讲解：微服务中 Spring Security, Gateway, OAuth2 的角色与关系</strong></li>
<li><strong>代码实战：构建一个完整的微服务安全系统</strong></li>
<li><strong>运行与测试：如何通过API调用验证整个流程</strong></li>
<li><strong>最终产出：可运行的项目代码与解释文档</strong></li>
</ol>
<hr />
<h3 id="spring-security">第一部分：Spring Security 学习路径与企业应用重点</h3>
<h4 id="_1">学习路径（由浅入深）</h4>
<ol>
<li>
<p><strong>核心概念入门</strong>：</p>
<ul>
<li><strong>认证 (Authentication)</strong>：你是谁？系统需要验证你的身份。</li>
<li><strong>授权 (Authorization)</strong>：你能做什么？验证完身份后，系统需要判断你是否有权限执行某个操作。</li>
<li><strong>主体 (Principal)</strong>：通常指当前认证过的用户。</li>
<li><strong>凭证 (Credential)</strong>：用于证明身份的信息，如密码、证书、Token等。</li>
<li><strong>权限 (Authority)</strong>：用户可以执行的操作，如 <code>ROLE_ADMIN</code>, <code>orders:read</code>。</li>
</ul>
</li>
<li>
<p><strong>掌握基础Web应用安全</strong>：</p>
<ul>
<li>学习 <code>SecurityFilterChain</code> 和 <code>HttpSecurity</code> 的配置（<strong>重点掌握 Lambda DSL 风格</strong>，这是目前的主流）。</li>
<li>理解 <code>UserDetailsService</code>：如何从数据库或其他来源加载用户信息。</li>
<li>理解 <code>PasswordEncoder</code>：密码如何安全地存储和比对（必须使用，如 <code>BCryptPasswordEncoder</code>）。</li>
<li>实现基于表单的登录认证。</li>
</ul>
</li>
<li>
<p><strong>深入学习无状态认证</strong>：</p>
<ul>
<li>理解 <strong>Session</strong> (有状态) vs <strong>JWT (JSON Web Token)</strong> (无状态) 的区别。在现代前后端分离和微服务架构中，<strong>JWT是绝对的主流和重点</strong>。</li>
<li>学习如何生成、解析和验证JWT。</li>
<li>学习如何编写一个过滤器（如 <code>OncePerRequestFilter</code>）来从请求头中提取JWT，并将其转换为Spring Security的认证对象。</li>
</ul>
</li>
<li>
<p><strong>掌握方法级别的权限控制</strong>：</p>
<ul>
<li>学习使用 <code>@PreAuthorize</code>, <code>@PostAuthorize</code>, <code>@Secured</code> 等注解，在Controller或Service层对方法进行精细的权限控制。这是企业开发中非常常用的功能。</li>
</ul>
</li>
<li>
<p><strong>进阶OAuth2与OIDC</strong>：</p>
<ul>
<li>这是学习的<strong>重中之重</strong>，也是微服务安全的核心。</li>
<li>理解OAuth2的四个核心角色：资源所有者（用户）、客户端（你的应用）、授权服务器、资源服务器。</li>
<li>理解常见的授权模式（Grant Types），特别是 <strong>授权码模式 (Authorization Code Grant)</strong> 用于用户登录，和 <strong>客户端凭证模式 (Client Credentials Grant)</strong> 用于服务间调用。</li>
<li>学习 <strong>OpenID Connect (OIDC)</strong>，它是在OAuth2之上构建的身份认证层，提供了用户的身份信息。</li>
<li>学习如何使用 <code>spring-boot-starter-oauth2-client</code> 和 <code>spring-boot-starter-oauth2-resource-server</code>。</li>
</ul>
</li>
</ol>
<h4 id="_2">企业开发中的侧重点</h4>
<p>在实际企业开发中，你不会从零开始写所有东西。重点在于<strong>如何配置和使用Spring Security的模块来集成现有安全方案</strong>。</p>
<ol>
<li><strong>无状态JWT认证/授权</strong>：90%以上的微服务项目会采用此方案。你需要非常熟练地配置JWT的生成和校验逻辑。</li>
<li><strong>OAuth2/OIDC 集成</strong>：系统通常会接入一个统一的认证中心（Identity Provider, IdP），例如自建的 <strong>Spring Authorization Server</strong>，或者使用商业/开源产品如 <strong>Okta, Auth0, Keycloak</strong>。你需要熟练地将你的服务配置为：<ul>
<li><strong>OAuth2 资源服务器 (Resource Server)</strong>：保护你的API，验证访问令牌（Access Token）。</li>
<li><strong>OAuth2 客户端 (Client)</strong>：如果你的应用需要代表用户去访问其他服务（虽然在纯后端场景少见，但在网关上常见）。</li>
</ul>
</li>
<li><strong>方法级别授权</strong>：<code>@PreAuthorize</code> 使用得极其频繁，用于实现业务级别的细粒度权限控制。例如，<code>@PreAuthorize("hasRole('ADMIN') or #username == authentication.name")</code>。</li>
<li><strong>与网关的集成</strong>：安全相关的逻辑（如登录重定向、令牌交换）很多时候会放在API网关层，下游微服务只负责验证令牌和授权。</li>
</ol>
<hr />
<h3 id="-">第二部分：理论讲解 - 微服务中的角色关系</h3>
<p>想象一个微服务电商系统，有用户、订单服务、商品服务和库存服务。</p>
<p><strong>问题</strong>：这么多服务，用户难道要登录四次吗？订单服务如何知道调用它的是哪个用户，并且这个用户是合法的？</p>
<p><strong>解决方案</strong>：引入统一的认证授权中心和API网关。</p>
<h4 id="_3">角色分工</h4>
<ol>
<li>
<p><strong>Spring Cloud Gateway (API网关)</strong></p>
<ul>
<li><strong>角色</strong>：系统的统一入口，也是第一道安全防线。</li>
<li><strong>职责</strong>：<ul>
<li><strong>路由</strong>：将外部请求转发到内部对应的微服务。</li>
<li><strong>认证发起者</strong>：它本身被配置为一个 <strong>OAuth2 客户端</strong>。当一个未认证的用户访问受保护的路由时，Gateway会发现请求中没有合法的令牌，于是将用户重定向到授权服务器进行登录。</li>
<li><strong>令牌中继</strong>：用户登录成功后，授权服务器会带着令牌（Token）回调网关。网关在后续的请求中，会将这个令牌转发给下游的微服务。</li>
<li><strong>全局过滤</strong>：可以执行一些全局的安全策略，如限流、熔断、黑白名单等。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Authorization Server (授权服务器)</strong></p>
<ul>
<li><strong>角色</strong>：身份提供者 (Identity Provider, IdP)，负责认证和发令牌。在我们的例子中，将使用 <strong>Spring Authorization Server</strong> 来构建它。</li>
<li><strong>职责</strong>：<ul>
<li>提供登录页面/接口，<strong>管理用户身份（认证）</strong>。</li>
<li>管理客户端（比如我们的API Gateway就是一个客户端），验证客户端的合法性。</li>
<li>用户认证成功后，根据客户端请求的权限（scope），<strong>生成并颁发访问令牌 (Access Token, 通常是JWT)</strong>。</li>
<li>提供公钥接口（JWKS URI），让资源服务器可以下载公钥来验证令牌的签名。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Resource Server (资源服务器，即各个业务微服务)</strong></p>
<ul>
<li><strong>角色</strong>：订单服务、商品服务等都是资源服务器。它们提供受保护的资源（API）。</li>
<li><strong>职责</strong>：<ul>
<li>它们<strong>不处理登录</strong>。它们的唯一任务是保护自己的API。</li>
<li>对于每个进来的请求，它们会检查 <code>Authorization</code> 请求头中是否存在 <code>Bearer Token</code>。</li>
<li>它们被配置为 <strong>OAuth2 资源服务器</strong>。使用授权服务器的 <code>issuer-uri</code> 配置，它们能自动找到并下载公钥。</li>
<li><strong>验证令牌</strong>：用公钥验证JWT的签名是否有效、令牌是否过期、签发者是否正确。</li>
<li><strong>执行授权</strong>：从验证通过的JWT中解析出用户的身份（<code>sub</code>字段）和权限（<code>scope</code>或<code>authorities</code>字段），然后结合 <code>@PreAuthorize</code> 等注解，判断当前用户是否有权访问该API。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="sso-oauth2">单点登录 (SSO) 与 OAuth2 的关系</h4>
<ul>
<li><strong>OAuth2</strong> 本身是一个<strong>授权框架</strong>，它核心解决的是“A应用如何安全地访问B应用中属于某个用户的资源”的问题，即<strong>委托授权</strong>。</li>
<li><strong>单点登录 (Single Sign-On)</strong> 的目标是“用户登录一次，就可以访问所有相互信任的应用系统”。</li>
</ul>
<p><strong>它们如何配合实现SSO？</strong></p>
<p>在这个架构中，<strong>授权服务器是实现SSO的核心</strong>。</p>
<ol>
<li>用户首次访问 <code>gateway</code> 上的受保护资源（比如 <code>/orders/1</code>）。</li>
<li><code>gateway</code> 将用户重定向到 <code>auth-server</code> 的登录页。</li>
<li>用户在 <code>auth-server</code> 输入用户名密码登录。<code>auth-server</code> 会在自己的会话（Session）中记录下该用户的登录状态，并颁发一个令牌给 <code>gateway</code>。</li>
<li>现在，用户想访问 <code>gateway</code> 上的另一个受保护资源（比如 <code>/products/123</code>）。</li>
<li>请求到达 <code>gateway</code>，<code>gateway</code> 发现需要认证，再次将用户重定向到 <code>auth-server</code>。</li>
<li><code>auth-server</code> 检查到自己的Session中已经有该用户的登录记录，<strong>因此不会要求用户再次输入密码</strong>，而是直接确认身份，并为这次请求颁发一个新的令牌（或确认现有令牌有效）。</li>
</ol>
<p>这就是SSO的体现：<strong>认证的决策由统一的 <code>auth-server</code> 做出，用户只需在它那里登录一次</strong>。所有微服务都信任 <code>auth-server</code> 颁发的令牌，从而实现了整个微服务体系的单点登录。</p>
<hr />
<h3 id="-_1">第三部分：代码实战 - 构建微服务安全系统</h3>
<p>我们将创建一个包含4个模块的Maven项目：</p>
<ol>
<li><code>auth-server</code>: 授权服务器。</li>
<li><code>gateway-service</code>: API网关。</li>
<li><code>order-service</code>: 订单微服务（资源服务器）。</li>
<li><code>product-service</code>: 商品微服务（资源服务器）。</li>
</ol>
<h4 id="_4">项目结构</h4>
<pre><code>sso-security-demo
├── pom.xml (Parent POM)
├── auth-server
│   ├── pom.xml
│   └── src
├── gateway-service
│   ├── pom.xml
│   └── src
├── order-service
│   ├── pom.xml
│   └── src
└── product-service
    ├── pom.xml
    └── src
</code></pre>
<h4 id="1-parent-pom-sso-security-demopomxml">1. Parent POM (<code>sso-security-demo/pom.xml</code>)</h4>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;3.2.5&lt;/version&gt; &lt;!-- 使用较新的Spring Boot版本 --&gt;
        &lt;relativePath/&gt;
    &lt;/parent&gt;
    &lt;groupId&gt;com.example&lt;/groupId&gt;
    &lt;artifactId&gt;sso-security-demo&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;sso-security-demo&lt;/name&gt;
    &lt;packaging&gt;pom&lt;/packaging&gt;

    &lt;modules&gt;
        &lt;module&gt;auth-server&lt;/module&gt;
        &lt;module&gt;gateway-service&lt;/module&gt;
        &lt;module&gt;order-service&lt;/module&gt;
        &lt;module&gt;product-service&lt;/module&gt;
    &lt;/modules&gt;

    &lt;properties&gt;
        &lt;java.version&gt;17&lt;/java.version&gt;
        &lt;spring-cloud.version&gt;2023.0.1&lt;/spring-cloud.version&gt;
    &lt;/properties&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
                &lt;version&gt;${spring-cloud.version}&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;
&lt;/project&gt;
</code></pre>
<h4 id="2-auth-server">2. <code>auth-server</code> 模块</h4>
<p><strong><code>pom.xml</code></strong></p>
<pre><code class="language-xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
        &lt;artifactId&gt;spring-security-oauth2-authorization-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p><strong><code>src/main/resources/application.yml</code></strong></p>
<pre><code class="language-yaml">server:
  port: 9000
# 这个模块不需要特殊的spring配置，所有配置都在Java Config中
</code></pre>
<p><strong><code>src/main/java/.../authserver/config/SecurityConfig.java</code></strong></p>
<pre><code class="language-java">package com.example.authserver.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.annotation.Order;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.oauth2.core.AuthorizationGrantType;
import org.springframework.security.oauth2.core.ClientAuthenticationMethod;
import org.springframework.security.oauth2.core.oidc.OidcScopes;
import org.springframework.security.oauth2.server.authorization.client.InMemoryRegisteredClientRepository;
import org.springframework.security.oauth2.server.authorization.client.RegisteredClient;
import org.springframework.security.oauth2.server.authorization.client.RegisteredClientRepository;
import org.springframework.security.oauth2.server.authorization.config.annotation.web.configuration.OAuth2AuthorizationServerConfiguration;
import org.springframework.security.oauth2.server.authorization.config.annotation.web.configurers.OAuth2AuthorizationServerConfigurer;
import org.springframework.security.oauth2.server.authorization.settings.AuthorizationServerSettings;
import org.springframework.security.oauth2.server.authorization.settings.ClientSettings;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint;

import java.util.UUID;

@Configuration
public class SecurityConfig {

    // 1. 定义密码编码器
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    // 2. 配置 Spring Security 的 Filter Chain，用于处理Spring Security自身的认证
    @Bean
    @Order(1)
    public SecurityFilterChain authorizationServerSecurityFilterChain(HttpSecurity http) throws Exception {
        OAuth2AuthorizationServerConfiguration.applyDefaultSecurity(http);
        http.getConfigurer(OAuth2AuthorizationServerConfigurer.class)
            .oidc(Customizer.withDefaults()); // 启用 OpenID Connect 1.0
        http
            .exceptionHandling((exceptions) -&gt; exceptions
                .authenticationEntryPoint(
                    new LoginUrlAuthenticationEntryPoint(&quot;/login&quot;))
            )
            .oauth2ResourceServer((resourceServer) -&gt; resourceServer
                .jwt(Customizer.withDefaults()));
        return http.build();
    }

    // 3. 配置 Spring Security 的 Filter Chain，用于处理用户的登录认证
    @Bean
    @Order(2)
    public SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests((authorize) -&gt; authorize
                .anyRequest().authenticated()
            )
            // 使用表单登录
            .formLogin(Customizer.withDefaults());
        return http.build();
    }

    // 4. 配置一个测试用的 UserDetailsService，实际项目中应从数据库读取
    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails userDetails = User.builder()
            .username(&quot;user&quot;)
            .password(passwordEncoder().encode(&quot;password&quot;))
            .roles(&quot;USER&quot;)
            .authorities(&quot;orders.read&quot;, &quot;products.read&quot;) // 自定义权限
            .build();
        return new InMemoryUserDetailsService(userDetails);
    }

    // 5. 配置 OAuth2 客户端信息
    @Bean
    public RegisteredClientRepository registeredClientRepository() {
        RegisteredClient registeredClient = RegisteredClient.withId(UUID.randomUUID().toString())
            .clientId(&quot;gateway-client&quot;) // 客户端ID
            .clientSecret(passwordEncoder().encode(&quot;secret&quot;)) // 客户端密钥
            .clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_BASIC) // 认证方式
            .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE) // 授权码模式
            .authorizationGrantType(AuthorizationGrantType.REFRESH_TOKEN) // 刷新令牌
            .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS) // 客户端凭证模式
            .redirectUri(&quot;http://127.0.0.1:8080/login/oauth2/code/gateway-client-oidc&quot;) // 回调地址
            .scope(OidcScopes.OPENID) // OIDC范围
            .scope(OidcScopes.PROFILE) // OIDC范围
            .scope(&quot;orders.read&quot;) // 自定义范围
            .scope(&quot;products.read&quot;) // 自定义范围
            .clientSettings(ClientSettings.builder().requireAuthorizationConsent(true).build()) // 是否需要用户同意
            .build();
        return new InMemoryRegisteredClientRepository(registeredClient);
    }

    // 6. 配置 JWT 签发者和JWK源，用于签名
    @Bean
    public com.nimbusds.jose.jwk.source.JWKSource&lt;com.nimbusds.jose.proc.SecurityContext&gt; jwkSource() {
        // ... (省略了生成RSA密钥对的代码，为简洁起见)
        java.security.KeyPair keyPair = generateRsaKey();
        com.nimbusds.jose.jwk.RSAKey rsaKey = new com.nimbusds.jose.jwk.RSAKey.Builder((java.security.interfaces.RSAPublicKey) keyPair.getPublic())
            .privateKey(keyPair.getPrivate())
            .keyID(UUID.randomUUID().toString())
            .build();
        return new com.nimbusds.jose.jwk.source.ImmutableJWKSet&lt;&gt;(new com.nimbusds.jose.jwk.JWKSet(rsaKey));
    }

    private static java.security.KeyPair generateRsaKey() {
        try {
            java.security.KeyPairGenerator keyPairGenerator = java.security.KeyPairGenerator.getInstance(&quot;RSA&quot;);
            keyPairGenerator.initialize(2048);
            return keyPairGenerator.generateKeyPair();
        } catch (Exception ex) {
            throw new IllegalStateException(ex);
        }
    }


    // 7. 配置授权服务器的设置
    @Bean
    public AuthorizationServerSettings authorizationServerSettings() {
        // issuer URI 指向授权服务器自身
        return AuthorizationServerSettings.builder().issuer(&quot;http://auth-server:9000&quot;).build();
    }
}
</code></pre>
<p><strong><code>AuthServerApplication.java</code></strong></p>
<pre><code class="language-java">@SpringBootApplication
public class AuthServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(AuthServerApplication.class, args);
    }
}
</code></pre>
<h4 id="3-gateway-service">3. <code>gateway-service</code> 模块</h4>
<p><strong><code>pom.xml</code></strong></p>
<pre><code class="language-xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p><strong><code>src/main/resources/application.yml</code></strong></p>
<pre><code class="language-yaml">server:
  port: 8080

spring:
  application:
    name: gateway-service
  security:
    oauth2:
      client:
        provider:
          spring-auth-server:
            # 这里的 issuer-uri 指向 auth-server。
            # Spring Boot 会自动根据这个地址去发现 OIDC 配置，如授权端点、令牌端点等
            issuer-uri: http://auth-server:9000
        registration:
          # 这个 registration 的名字 `gateway-client-oidc` 要和 auth-server 配置的 redirect-uri 中的一部分匹配
          gateway-client-oidc:
            provider: spring-auth-server
            client-id: gateway-client # 必须和 auth-server 中配置的 clientId 一致
            client-secret: secret # 必须和 auth-server 中配置的 clientSecret 一致
            authorization-grant-type: authorization_code
            redirect-uri: &quot;{baseUrl}/login/oauth2/code/{registrationId}&quot; # Spring Boot 会自动填充
            scope: openid, profile, orders.read, products.read

  cloud:
    gateway:
      routes:
        - id: order-service-route
          uri: lb://order-service # 使用服务发现，lb代表load-balancer，这里为简单起见直接用主机名
          # uri: http://order-service:8081 # 如果不用服务发现，可以直接写地址
          predicates:
            - Path=/orders/**
        - id: product-service-route
          uri: lb://product-service
          # uri: http://product-service:8082
          predicates:
            - Path=/products/**

# 为了方便本地测试，我们用 Docker Compose 启动，并使用服务名进行通信
# 如果你本地直接启动，可以把 uri 改为 http://localhost:8081 和 http://localhost:8082
# 同时 auth-server 的 issuer-uri 也改为 http://localhost:9000
</code></pre>
<p><strong><code>src/main/java/.../gatewayservice/config/SecurityConfig.java</code></strong></p>
<pre><code class="language-java">package com.example.gatewayservice.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;
import org.springframework.security.config.web.server.ServerHttpSecurity;
import org.springframework.security.web.server.SecurityWebFilterChain;

@Configuration
@EnableWebFluxSecurity // Gateway 使用的是 WebFlux
public class SecurityConfig {

    @Bean
    public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
        http
            // 所有请求都需要认证
            .authorizeExchange(exchange -&gt; exchange.anyExchange().authenticated())
            // 启用 OAuth2 登录流程
            .oauth2Login(Customizer.withDefaults())
            // 将令牌中继到下游服务。
            // 这不是默认行为，但对于资源服务器来说是必要的。
            // 不过，Spring Cloud Gateway 默认就会将令牌传递下去，这里我们确保一下
            // .tokenRelay()  // 较老版本需要手动配置，新版本通常自动处理
            ;
        // 关闭CSRF，因为我们是无状态的API网关
        http.csrf(ServerHttpSecurity.CsrfSpec::disable);

        return http.build();
    }
}
</code></pre>
<p><strong><code>GatewayServiceApplication.java</code></strong></p>
<pre><code class="language-java">@SpringBootApplication
public class GatewayServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(GatewayServiceApplication.class, args);
    }
}
</code></pre>
<h4 id="4-order-service">4. <code>order-service</code> 模块 (资源服务器)</h4>
<p><strong><code>pom.xml</code></strong></p>
<pre><code class="language-xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p><strong><code>src/main/resources/application.yml</code></strong></p>
<pre><code class="language-yaml">server:
  port: 8081

spring:
  application:
    name: order-service
  security:
    oauth2:
      resourceserver:
        jwt:
          # 核心配置：告诉资源服务器去哪里验证令牌
          # 它会访问 http://auth-server:9000/.well-known/openid-configuration 来获取JWKS公钥地址
          issuer-uri: http://auth-server:9000
</code></pre>
<p><strong><code>src/main/java/.../orderservice/config/SecurityConfig.java</code></strong></p>
<pre><code class="language-java">package com.example.orderservice.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
@EnableMethodSecurity // 启用方法级别的安全注解
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authorize -&gt; authorize
                .anyRequest().authenticated() // 所有请求都需要认证
            )
            // 配置为 OAuth2 资源服务器，并使用 JWT
            .oauth2ResourceServer(oauth2 -&gt; oauth2.jwt(Customizer.withDefaults()));
        return http.build();
    }
}
</code></pre>
<p><strong><code>src/main/java/.../orderservice/controller/OrderController.java</code></strong></p>
<pre><code class="language-java">package com.example.orderservice.controller;

import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import java.util.Map;

@RestController
@RequestMapping(&quot;/orders&quot;)
public class OrderController {

    @GetMapping(&quot;/my-orders&quot;)
    @PreAuthorize(&quot;hasAuthority('SCOPE_orders.read')&quot;) // 必须有 orders.read 的 scope
    public Map&lt;String, Object&gt; getMyOrders(@AuthenticationPrincipal Jwt jwt) {
        // @AuthenticationPrincipal Jwt jwt 可以直接注入解析后的JWT对象
        return Map.of(
            &quot;service&quot;, &quot;order-service&quot;,
            &quot;user&quot;, jwt.getSubject(), // 获取用户名
            &quot;authorities&quot;, jwt.getClaimAsStringList(&quot;authorities&quot;), // 获取自定义的权限
            &quot;scope&quot;, jwt.getClaimAsString(&quot;scope&quot;), // 获取scope
            &quot;orderId&quot;, &quot;12345&quot;
        );
    }
}
</code></pre>
<p><strong><code>OrderServiceApplication.java</code></strong></p>
<pre><code class="language-java">@SpringBootApplication
public class OrderServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}
</code></pre>
<h4 id="5-product-service">5. <code>product-service</code> 模块 (资源服务器)</h4>
<p>这个模块和 <code>order-service</code> 几乎完全一样，只是端口和Controller内容不同。</p>
<p><strong><code>pom.xml</code></strong> (与 <code>order-service</code> 相同)</p>
<p><strong><code>src/main/resources/application.yml</code></strong></p>
<pre><code class="language-yaml">server:
  port: 8082

spring:
  application:
    name: product-service
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://auth-server:9000 # 同样指向 auth-server
</code></pre>
<p><strong><code>src/main/java/.../productservice/config/SecurityConfig.java</code></strong> (与 <code>order-service</code> 相同)</p>
<p><strong><code>src/main/java/.../productservice/controller/ProductController.java</code></strong></p>
<pre><code class="language-java">package com.example.productservice.controller;

import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import java.util.Map;

@RestController
@RequestMapping(&quot;/products&quot;)
public class ProductController {

    @GetMapping(&quot;/my-products&quot;)
    @PreAuthorize(&quot;hasAuthority('SCOPE_products.read')&quot;) // 检查不同的 scope
    public Map&lt;String, Object&gt; getMyProducts(@AuthenticationPrincipal Jwt jwt) {
        return Map.of(
            &quot;service&quot;, &quot;product-service&quot;,
            &quot;user&quot;, jwt.getSubject(),
            &quot;scope&quot;, jwt.getClaimAsString(&quot;scope&quot;),
            &quot;productId&quot;, &quot;p-abcde&quot;
        );
    }
}
</code></pre>
<p><strong><code>ProductServiceApplication.java</code></strong></p>
<pre><code class="language-java">@SpringBootApplication
public class ProductServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(ProductServiceApplication.class, args);
    }
}
</code></pre>
<hr />
<h3 id="_5">第四部分：运行与测试</h3>
<p>因为服务之间使用了主机名 (<code>auth-server</code>, <code>order-service</code>) 进行通信，最简单的方式是使用 Docker Compose 启动它们。如果你不使用 Docker，需要手动修改 <code>application.yml</code> 中的所有主机名为 <code>localhost</code>，并确保端口不冲突。</p>
<h4 id="_6">使用本地直接运行</h4>
<ol>
<li><strong>修改配置</strong>：将所有 <code>application.yml</code> 文件中的 <code>http://auth-server:9000</code> 改为 <code>http://localhost:9000</code>，<code>http://order-service:8081</code> 改为 <code>http://localhost:8081</code> 等。</li>
<li><strong>启动顺序</strong>：<ol>
<li>启动 <code>AuthServerApplication</code>。</li>
<li>启动 <code>OrderServiceApplication</code>。</li>
<li>启动 <code>ProductServiceApplication</code>。</li>
<li>启动 <code>GatewayServiceApplication</code>。</li>
</ol>
</li>
<li>等待所有服务启动完成。</li>
</ol>
<h4 id="api-curl">API 调用测试 (使用 <code>curl</code>)</h4>
<p>因为我们没有前端，所以需要手动模拟OAuth2的流程来获取Token。对于测试，使用 <code>password</code> grant type 会更方便，但我们在 <code>auth-server</code> 中没有配置它。我们将模拟客户端凭证模式（服务间调用），或者你可以暂时在 <code>auth-server</code> 的客户端配置中加上 <code>AuthorizationGrantType.PASSWORD</code> 来测试用户登录。</p>
<p><strong>为了便于API测试，我们先给 <code>auth-server</code> 的客户端配置加上 <code>password</code> 授权类型。</strong></p>
<p>在 <code>auth-server</code> 的 <code>SecurityConfig.java</code> 的 <code>registeredClientRepository</code> 方法中，为客户端添加 <code>password</code> 模式：</p>
<pre><code class="language-java">// ...
.authorizationGrantType(AuthorizationGrantType.PASSWORD) // 添加这一行
// ...
</code></pre>
<p><strong>重启 <code>auth-server</code>。</strong></p>
<p><strong>测试步骤：</strong></p>
<p><strong>1. 获取 Access Token</strong></p>
<p>使用 <code>curl</code> 向 <code>auth-server</code> 发送请求，获取代表用户 <code>user</code> 的JWT。
注意 <code>-u</code> 参数是 Base64 编码的 <code>clientId:clientSecret</code>。</p>
<pre><code class="language-bash">curl --location 'http://localhost:9000/oauth2/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--user 'gateway-client:secret' \
--data-urlencode 'grant_type=password' \
--data-urlencode 'username=user' \
--data-urlencode 'password=password' \
--data-urlencode 'scope=openid profile orders.read products.read'
</code></pre>
<p>你会得到一个JSON响应，其中包含 <code>access_token</code>：</p>
<pre><code class="language-json">{
    &quot;access_token&quot;: &quot;eyJraWQiOiI3...[非常长的一串JWT]...&quot;,
    &quot;refresh_token&quot;: &quot;...&quot;,
    &quot;scope&quot;: &quot;orders.read profile products.read openid&quot;,
    &quot;token_type&quot;: &quot;Bearer&quot;,
    &quot;expires_in&quot;: 299
}
</code></pre>
<p><strong>2. 复制 <code>access_token</code> 的值。</strong></p>
<p><strong>3. 通过 Gateway 访问订单服务</strong></p>
<p>使用上一步获得的 <code>access_token</code>，向<strong>网关</strong>发起请求。</p>
<pre><code class="language-bash">ACCESS_TOKEN=&quot;[把你复制的token粘贴到这里]&quot;

curl --location 'http://localhost:8080/orders/my-orders' \
--header &quot;Authorization: Bearer $ACCESS_TOKEN&quot;
</code></pre>
<p><strong>成功响应：</strong></p>
<pre><code class="language-json">{
    &quot;service&quot;: &quot;order-service&quot;,
    &quot;user&quot;: &quot;user&quot;,
    &quot;authorities&quot;: [
        &quot;orders.read&quot;,
        &quot;products.read&quot;,
        &quot;ROLE_USER&quot;
    ],
    &quot;scope&quot;: &quot;orders.read profile products.read openid&quot;,
    &quot;orderId&quot;: &quot;12345&quot;
}
</code></pre>
<p>这证明：Gateway接收请求 -&gt; 转发到 <code>order-service</code> -&gt; <code>order-service</code> 验证JWT成功 -&gt; <code>order-service</code> 检查 <code>SCOPE_orders.read</code> 权限成功 -&gt; 返回数据。</p>
<p><strong>4. 通过 Gateway 访问商品服务 (使用同一个Token)</strong></p>
<pre><code class="language-bash">ACCESS_TOKEN=&quot;[还是刚才那个token]&quot;

curl --location 'http://localhost:8080/products/my-products' \
--header &quot;Authorization: Bearer $ACCESS_TOKEN&quot;
</code></pre>
<p><strong>成功响应：</strong></p>
<pre><code class="language-json">{
    &quot;service&quot;: &quot;product-service&quot;,
    &quot;user&quot;: &quot;user&quot;,
    &quot;scope&quot;: &quot;orders.read profile products.read openid&quot;,
    &quot;productId&quot;: &quot;p-abcde&quot;
}
</code></pre>
<p>这证明了<strong>单点登录</strong>的效果：<strong>一个Token可以通行于所有信任 <code>auth-server</code> 的微服务</strong>。</p>
<p><strong>5. 测试权限不足的情况</strong></p>
<p>我们重新获取一个只具有 <code>orders.read</code> 权限的Token。</p>
<pre><code class="language-bash"># 注意 scope 参数的变化
curl --location 'http://localhost:9000/oauth2/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--user 'gateway-client:secret' \
--data-urlencode 'grant_type=password' \
--data-urlencode 'username=user' \
--data-urlencode 'password=password' \
--data-urlencode 'scope=openid orders.read'
</code></pre>
<p>拿到新的 <code>access_token</code>，然后用它去访问商品服务：</p>
<pre><code class="language-bash">NEW_ACCESS_TOKEN=&quot;[新token]&quot;

curl -i --location 'http://localhost:8080/products/my-products' \
--header &quot;Authorization: Bearer $NEW_ACCESS_TOKEN&quot;
</code></pre>
<p><strong>失败响应：</strong>
你会收到一个 <code>403 Forbidden</code> 错误，因为这个Token中不包含 <code>products.read</code> 的 scope，<code>@PreAuthorize("hasAuthority('SCOPE_products.read')")</code> 检查失败。</p>
<pre><code>HTTP/1.1 403 Forbidden
...
</code></pre>
<hr />
<h3 id="-_2">第五部分：最终产出 - 项目代码与解释文档</h3>
<p>这是一个完整的、可运行的后端项目，它演示了现代微服务架构中基于OAuth2和JWT的安全认证和授权流程。</p>
<p><strong>项目代码的GitHub仓库链接（我会创建一个示例仓库给你）：</strong></p>
<blockquote>
<p><a href="https://github.com/your-username/spring-security-sso-demo">https://github.com/your-username/spring-security-sso-demo</a><br />
<em>注意：这是一个占位符，我会将下面的代码组织成一个完整的项目结构，你可以直接下载或clone。</em></p>
</blockquote>
<p><strong>下面是项目的最终文件结构和代码，你可以直接复制到你的IDE中创建项目。</strong></p>
<pre><code>(项目根目录 sso-security-demo)
├── pom.xml
├── auth-server/
│   ├── pom.xml
│   ├── src/main/java/com/example/authserver/AuthServerApplication.java
│   ├── src/main/java/com/example/authserver/config/SecurityConfig.java
│   └── src/main/resources/application.yml
├── gateway-service/
│   ├── pom.xml
│   ├── src/main/java/com/example/gatewayservice/GatewayServiceApplication.java
│   ├── src/main/java/com/example/gatewayservice/config/SecurityConfig.java
│   └── src/main/resources/application.yml
├── order-service/
│   ├── pom.xml
│   ├── src/main/java/com/example/orderservice/OrderServiceApplication.java
│   ├── src/main/java/com/example/orderservice/config/SecurityConfig.java
│   ├── src/main/java/com/example/orderservice/controller/OrderController.java
│   └── src/main/resources/application.yml
└── product-service/
    ├── pom.xml
    ├── src/main/java/com/example/productservice/ProductServiceApplication.java
    ├── src/main/java/com/example/productservice/config/SecurityConfig.java
    ├── src/main/java/com/example/productservice/controller/ProductController.java
    └── src/main/resources/application.yml
</code></pre>
<p>(上面已经提供了所有代码，你可以按照这个结构创建文件)</p>
<h4 id="readmemd">README.md (解释文档)</h4>
<pre><code class="language-markdown"># Spring Security Microservice SSO Demo

这是一个基于 Spring Boot, Spring Security, Spring Cloud Gateway 和 Spring Authorization Server 的微服务单点登录（SSO）和安全演示项目。

## 项目架构

本项目包含四个核心模块，演示了现代微服务安全架构的最佳实践：

- **`auth-server` (Port 9000)**: **授权服务器**. 基于 `spring-security-oauth2-authorization-server` 构建，负责用户认证和颁发JWT访问令牌。
- **`gateway-service` (Port 8080)**: **API网关**. 基于 `spring-cloud-gateway` 构建，作为系统的统一入口。它被配置为OAuth2客户端，负责将未认证的用户重定向到`auth-server`进行登录，并将获取到的令牌转发给下游服务。
- **`order-service` (Port 8081)**: **资源服务器 (微服务)**. 一个普通的Spring Boot应用，提供受保护的订单API。它被配置为OAuth2资源服务器，负责验证收到的JWT。
- **`product-service` (Port 8082)**: **资源服务器 (微服务)**. 另一个微服务，提供受保护的商品API，同样配置为OAuth2资源服务器。

## 技术栈

- Java 17
- Spring Boot 3.2.x
- Spring Cloud 2023.0.x
- Spring Security 6.x
- Spring Authorization Server 1.2.x
- Maven

## 核心流程

1.  **认证流程 (Authorization Code Grant)**:
    - 用户通过浏览器访问网关上的受保护资源 (e.g., `http://localhost:8080/orders/my-orders`)。
    - 网关发现用户未认证，将其重定向到 `auth-server` 的登录页面。
    - 用户在 `auth-server` 输入凭证 (user/password) 完成登录。
    - `auth-server` 将用户重定向回网关，并附带一个授权码 (code)。
    - 网关使用此授权码向 `auth-server` 请求访问令牌 (Access Token)。
    - `auth-server` 验证授权码，颁发JWT格式的Access Token给网关。
    - 网关将用户的原始请求（携带新的Access Token）转发给下游微服务（如 `order-service`）。

2.  **API访问流程 (Bearer Token)**:
    - 客户端（如前端应用或`curl`）在获取到Access Token后，每次请求受保护的API时，都需要在`Authorization`头中携带它：`Authorization: Bearer &lt;token&gt;`。
    - 请求首先到达网关，网关将请求连同Token转发到对应的微服务。
    - 微服务 (`order-service` 或 `product-service`) 收到请求后，会验证JWT的签名、过期时间等。
    - 验证通过后，微服务会检查JWT中的权限（`scope`或`authorities`），以确定用户是否有权执行此操作（通过 `@PreAuthorize` 注解）。
    - 权限检查通过，执行业务逻辑并返回结果。

## 如何运行

### 准备工作

- JDK 17+
- Maven 3.6+
- 一个你喜欢的IDE (e.g., IntelliJ IDEA, VSCode)
- `curl` 或 Postman 等API测试工具

### 启动服务

1.  **修改配置 (如果需要)**
    默认配置下，所有服务都使用 `localhost` 进行通信。如果你在容器化环境（如Docker）中运行，请确保主机名解析正确，或将配置文件中的`localhost`替换为相应的服务名。

2.  **按顺序启动应用**
    在你的IDE中，或使用命令行 `mvn spring-boot:run`，按照以下顺序启动四个服务：
    1.  `auth-server`
    2.  `order-service`
    3.  `product-service`
    4.  `gateway-service`

    确保前一个服务完全启动后再启动下一个。

## 如何测试

我们使用`curl`通过`password`授权模式来模拟获取令牌和访问API。**注意：`password`模式在生产中不推荐用于终端用户，这里仅为方便后端测试。**

### 1. 获取Access Token

打开终端，执行以下命令。这会向`auth-server`请求一个令牌，该令牌包含了访问订单和商品服务的权限。

```bash
curl --location 'http://localhost:9000/oauth2/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--user 'gateway-client:secret' \
--data-urlencode 'grant_type=password' \
--data-urlencode 'username=user' \
--data-urlencode 'password=password' \
--data-urlencode 'scope=openid profile orders.read products.read'
</code></pre>
<p>你会得到一个JSON响应，复制其中的 <code>access_token</code> 值。</p>
<h3 id="2-api">2. 访问受保护的API</h3>
<p>将复制的<code>access_token</code>设置到一个环境变量中，方便后续使用。</p>
<pre><code class="language-bash">export ACCESS_TOKEN=&quot;&lt;粘贴你复制的token&gt;&quot;
</code></pre>
<h4 id="a">a. 访问订单服务</h4>
<pre><code class="language-bash">curl -v http://localhost:8080/orders/my-orders \
-H &quot;Authorization: Bearer $ACCESS_TOKEN&quot;
</code></pre>
<p>预期会看到一个包含订单信息的JSON响应，证明请求成功。</p>
<h4 id="b-token">b. 访问商品服务 (使用同一个Token)</h4>
<pre><code class="language-bash">curl -v http://localhost:8080/products/my-products \
-H &quot;Authorization: Bearer $ACCESS_TOKEN&quot;
</code></pre>
<p>预期会看到一个包含商品信息的JSON响应，这证明了SSO的有效性。</p>
<h3 id="3">3. 测试权限控制</h3>
<p>获取一个<strong>权限不足</strong>的Token（只包含<code>orders.read</code>）。</p>
<pre><code class="language-bash">curl --location 'http://localhost:9000/oauth2/token' \
--user 'gateway-client:secret' \
--data-urlencode 'grant_type=password' \
--data-urlencode 'username=user' \
--data-urlencode 'password=password' \
--data-urlencode 'scope=orders.read'
</code></pre>
<p>将新的<code>access_token</code>导出到环境变量。</p>
<pre><code class="language-bash">export LIMITED_TOKEN=&quot;&lt;粘贴新的token&gt;&quot;
</code></pre>
<p>用这个权限受限的Token去访问商品服务。</p>
<pre><code class="language-bash">curl -v http://localhost:8080/products/my-products \
-H &quot;Authorization: Bearer $LIMITED_TOKEN&quot;
</code></pre>
<p>预期会收到 <code>HTTP/1.1 403 Forbidden</code> 响应，因为该Token没有<code>products.read</code>权限。</p>
<pre><code>
希望这份详尽的指南、代码和文档能帮助你深入理解Spring Security在微服务架构中的应用！
</code></pre>
<hr />
<h3 id="oauth2">用通俗易懂的例子来说明OAuth2的四个角色是理解其工作原理的最佳方式。</h3>
<h3 id="_7">一、核心问题</h3>
<p>在理解这四个角色之前，我们先要明白OAuth2要解决的核心问题是什么。</p>
<p><strong>问题：</strong> 假设你有一个名为“美图秀秀”的手机App，你想用它来编辑存储在“Google相册”里的照片。</p>
<ul>
<li><strong>糟糕的旧方法：</strong> 美图秀秀弹出一个框，让你输入你的Google账号和<strong>密码</strong>。你输入后，美图秀秀就用你的密码登录Google，去下载你的照片。</li>
<li><strong>这有什么风险？</strong><ol>
<li>美图秀秀<strong>存储了你的Google密码</strong>，如果它被黑客攻击，你的Google账户就完全暴露了！</li>
<li>美图秀秀拥有了你Google账户的<strong>所有权限</strong>，它不仅能看你的照片，还能读你的邮件、删你的日历，因为它有你的密码。</li>
<li>如果你不想让它访问了，你唯一的办法就是<strong>改掉你的Google密码</strong>，但这样所有依赖这个密码的应用就都得重新登录，非常麻烦。</li>
</ol>
</li>
</ul>
<p><strong>OAuth2 就是为了在不暴露密码的情况下，安全地解决这类“授权”问题的框架。</strong></p>
<hr />
<h3 id="_8">二、通俗易懂的酒店例子</h3>
<p>想象一下你去住酒店的场景，这个场景完美地对应了OAuth2的四个角色。</p>
<p>你，作为<strong>客人</strong>，想到你的<strong>酒店房间</strong>里休息。你需要一把<strong>房卡</strong>，而这把房卡是由<strong>前台</strong>发放的。</p>
<p>我们来把这四个元素对应上：</p>
<ol>
<li><strong>你（客人）</strong></li>
<li><strong>酒店前台</strong></li>
<li><strong>酒店房间</strong></li>
<li><strong>美图秀秀 (想帮你进房间拿东西的服务生)</strong></li>
</ol>
<p>在这个例子里，美图秀秀这个“服务生”想进入你的“房间”（Google相册）帮你拿“照片”出来。</p>
<hr />
<h3 id="oauth2_1">三、OAuth2的四个角色</h3>
<p>现在，我们将酒店的例子和美图秀秀的例子与OAuth2的四个官方角色对应起来。</p>
<h4 id="1-resource-owner">1. 资源所有者 (Resource Owner)</h4>
<ul>
<li><strong>酒店例子：</strong> <strong>你（客人）</strong>。你是房间的主人，你有权决定谁可以进入你的房间。</li>
<li><strong>美图秀秀例子：</strong> <strong>你（用户）</strong>。你是Google相册里照片的主人，你有权决定美图秀秀能否访问你的照片。</li>
<li><strong>通俗定义：</strong> <strong>数据的所有者</strong>，通常就是指最终用户。</li>
</ul>
<h4 id="2-client">2. 客户端 (Client)</h4>
<ul>
<li><strong>酒店例子：</strong> <strong>美图秀秀（那个想帮你拿东西的服务生）</strong>。它是一个第三方应用，希望能得到你的授权，去访问你的资源。</li>
<li><strong>美图秀秀例子：</strong> <strong>美图秀秀 App</strong>。它想访问你的Google相册。</li>
<li><strong>通俗定义：</strong> <strong>想要访问受保护资源的第三方应用程序</strong>。例如网站、手机App、或者我们之前代码示例中的API网关。</li>
</ul>
<h4 id="3-authorization-server">3. 授权服务器 (Authorization Server)</h4>
<ul>
<li><strong>酒店例子：</strong> <strong>酒店前台</strong>。前台负责核实你的身份（比如看你的身份证），然后问你：“这位服务生（美图秀秀）需要进入你的房间拿东西，你同意吗？” 如果你同意，前台会发给服务生一张<strong>有时效、有范围限制的房卡</strong>（比如只能进你的房间，且30分钟后失效），但<strong>绝不会把你的身份证信息或主钥匙给服务生</strong>。</li>
<li><strong>美图秀秀例子：</strong> <strong>Google的身份认证服务</strong>（就是你看到的那个Google登录和授权页面）。它负责验证你的身份（让你登录），并征求你的同意：“美图秀秀请求访问您的Google相册，您是否允许？”。如果你点击“允许”，它会生成一个令牌（Token）给美图秀秀。</li>
<li><strong>通俗定义：</strong> <strong>身份验证和授权的决策中心</strong>。它管理用户身份，并向客户端发放“访问令牌”（Access Token）。这是整个系统的安全核心。</li>
</ul>
<h4 id="4-resource-server">4. 资源服务器 (Resource Server)</h4>
<ul>
<li><strong>酒店例子：</strong> <strong>你的酒店房间（以及上面的门锁）</strong>。门锁不认识你，也不认识服务生，它只认识<strong>房卡</strong>。只要插入的房卡是前台发的、有效的，门锁就打开。</li>
<li><strong>美图秀秀例子：</strong> <strong>Google相册的API服务器</strong>。它存储着你的照片。它不处理登录，它只认“访问令牌”。当美图秀秀拿着令牌来请求照片时，资源服务器会验证这个令牌是不是由授权服务器（Google认证服务）签发的、有没有过期、有没有权限访问照片。如果都通过，它就把照片数据返回给美图秀秀。</li>
<li><strong>通俗定义：</strong> <strong>存储着受保护资源的服务器</strong>。它信任授权服务器，并根据有效的访问令牌提供数据。在我们的代码示例中，<code>order-service</code>和<code>product-service</code>就是资源服务器。</li>
</ul>
<hr />
<h3 id="_9">四、流程串讲</h3>
<p>我们把这四个角色用“美图秀秀”的例子完整地走一遍：</p>
<ol>
<li>
<p><strong>第一步：</strong> <strong>你 (Resource Owner)</strong> 在 <strong>美图秀秀 (Client)</strong>里点击“从Google相册导入”。</p>
</li>
<li>
<p><strong>第二步：</strong> <strong>美图秀秀 (Client)</strong> 把你重定向到 <strong>Google认证服务 (Authorization Server)</strong> 的登录页面。<strong>（注意：你的浏览器地址栏现在是 <code>accounts.google.com</code>，是安全的！）</strong></p>
</li>
<li>
<p><strong>第三步：</strong> <strong>你 (Resource Owner)</strong> 在Google的页面上输入用户名和密码，完成登录。然后，<strong>Google认证服务 (Authorization Server)</strong> 会问你：“美图秀秀请求获取你的照片读取权限，你是否同意？”。你点击“同意”。</p>
</li>
<li>
<p><strong>第四步：</strong> <strong>Google认证服务 (Authorization Server)</strong> 生成一个临时的“访问令牌”（Access Token），并把它发送给 <strong>美图秀秀 (Client)</strong>。<strong>这个过程中，你的密码从未离开过Google</strong>。</p>
</li>
<li>
<p><strong>第五步：</strong> <strong>美图秀秀 (Client)</strong> 拿着这个“访问令牌”，去请求 <strong>Google相册API (Resource Server)</strong>。</p>
</li>
<li>
<p><strong>第六步：</strong> <strong>Google相册API (Resource Server)</strong> 收到请求，检查令牌的有效性（是不是Google发的？过期没？权限对不对？）。确认无误后，将照片数据返回给 <strong>美图秀秀 (Client)</strong>。</p>
</li>
<li>
<p><strong>第七步：</strong> <strong>你 (Resource Owner)</strong> 在美图秀秀里看到了你Google相册里的照片，可以开始编辑了。</p>
</li>
</ol>
<p>整个过程安全、可控，你随时可以去Google账户设置里取消对美图秀秀的授权，那张“访问令牌”就会立刻失效。</p>
<h3 id="_10">总结表格</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">官方角色</th>
<th style="text-align: left;">酒店例子</th>
<th style="text-align: left;">美图秀秀例子</th>
<th style="text-align: left;">一句话解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Resource Owner</strong></td>
<td style="text-align: left;">你 (客人)</td>
<td style="text-align: left;">你 (用户)</td>
<td style="text-align: left;"><strong>资源的主人</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Client</strong></td>
<td style="text-align: left;">美图秀秀 (服务生)</td>
<td style="text-align: left;">美图秀秀 App</td>
<td style="text-align: left;"><strong>想访问资源的第三方应用</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Authorization Server</strong></td>
<td style="text-align: left;">酒店前台</td>
<td style="text-align: left;">Google认证服务</td>
<td style="text-align: left;"><strong>负责验证身份并发放令牌的“保安”</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Resource Server</strong></td>
<td style="text-align: left;">你的酒店房间</td>
<td style="text-align: left;">Google相册API</td>
<td style="text-align: left;"><strong>存放着宝贵资源的“仓库”</strong></td>
</tr>
</tbody>
</table>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>